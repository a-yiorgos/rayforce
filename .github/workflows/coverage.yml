name: Coverage

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  coverage:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y lcov
        
    - name: Generate coverage
      run: |
        make clean
        make coverage || echo "No tests available yet"
        
    - name: Create coverage report directory
      run: mkdir -p coverage_report
        
    - name: Create basic coverage report
      run: |
        echo "<html><body><h1>Coverage Report</h1><p>No tests available yet.</p></body></html>" > coverage_report/index.html
        
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: coverage_report/
        
    - name: Generate coverage badge
      if: github.ref == 'refs/heads/main'
      run: |
        if [ -f coverage.info ]; then
          COVERAGE=$(lcov --summary coverage.info | grep "lines" | awk '{print $4}' | cut -d'%' -f1)
        else
          COVERAGE=0
        fi
        echo "coverage=$COVERAGE" >> $GITHUB_OUTPUT
        
    - name: Update coverage badge
      if: github.ref == 'refs/heads/main'
      uses: schneegans/dynamic-badges-action@v1.6.0
      with:
        auth: ${{ secrets.GIST_SECRET }}
        gistID: ${{ secrets.GIST_ID }}
        filename: coverage.json
        label: coverage
        message: ${{ steps.coverage.outputs.coverage }}%
        color: ${{ steps.coverage.outputs.coverage > 80 && 'success' || steps.coverage.outputs.coverage > 60 && 'warning' || 'critical' }}
        
    - name: Update README badge
      if: github.ref == 'refs/heads/main'
      run: |
        if [ -f coverage.info ]; then
          COVERAGE=$(lcov --summary coverage.info | grep "lines" | awk '{print $4}' | cut -d'%' -f1)
        else
          COVERAGE=0
        fi
        
        if [ $COVERAGE -gt 80 ]; then
          COLOR="success"
        elif [ $COVERAGE -gt 60 ]; then
          COLOR="warning"
        else
          COLOR="critical"
        fi
        
        BADGE_URL="https://img.shields.io/badge/coverage-$COVERAGE%25-$COLOR"
        ARTIFACT_URL="https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # Update README.md if it exists
        if [ -f README.md ]; then
          # Check if badge already exists
          if grep -q "!\[coverage\]" README.md; then
            # Replace existing badge
            sed -i "s|!\[coverage\].*|![coverage]($BADGE_URL)|" README.md
          else
            # Add badge at the top of the file
            sed -i "1i ![coverage]($BADGE_URL)" README.md
          fi
          
          # Commit changes
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "Update coverage badge" || echo "No changes to commit"
          git push
        fi 